<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Calendario Laboral 2026 - Cataluña</title>
<style>
body{font-family:system-ui;background:#f6f7f9;margin:18px}
h1{text-align:center;margin-bottom:8px}
.top {display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:10px}
.legend{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.legend button{border:1px solid rgba(0,0,0,0.08);padding:6px 10px;border-radius:6px;cursor:pointer}
.legend button.active{outline:3px solid rgba(0,0,0,0.08)}
.calendar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.month{width:250px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.06)}
.month h2{text-transform:capitalize;text-align:center;margin:0 0 6px 0;font-size:16px}
.days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center}
.day{padding:6px;border-radius:6px;cursor:pointer;user-select:none}
.day.header{font-weight:700;background:#f0f2f5;border-radius:6px}
.vacio{background:transparent;cursor:default}
.laboral{background:#e8f8e8}
.festivo{background:#ff4d4d;color:white}
.puente{background:#fff07d}
.fiesta-local{background:#add8ff}
.cierra-empresa{background:#b399ff}
.jornada-parcial{background:#b3ffb3}
.vacaciones{background:#ff8c00;color:white}
.dias-libres{background:#ffcc80;color:black}
.resumen{max-width:760px;margin:10px auto 20px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.06)}
#tablaMensual{max-width:900px;margin:20px auto;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.06)}
table{width:100%;border-collapse:collapse;text-align:center}
th,td{border:1px solid #ccc;padding:6px}
.btn{padding:6px 10px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);cursor:pointer;background:white}
</style>
</head>
<body>

<h1>Calendario Laboral 2026 — Cataluña</h1>

<div class="top">
  <div class="legend" id="legend">
    <span><b>Marca como:</b></span>
    <button class="btn" data-class="puente" style="background:#fff07d">Puente</button>
    <button class="btn" data-class="fiesta-local" style="background:#add8ff">Fiesta local</button>
    <button class="btn" data-class="cierra-empresa" style="background:#b399ff">Cierre empresa</button>
    <button class="btn" data-class="jornada-parcial" style="background:#b3ffb3">Jornada parcial</button>
    <button class="btn" data-class="vacaciones" style="background:#ff8c00">Vacaciones</button>
    <button class="btn" data-class="dias-libres" style="background:#ffcc80">Días libres</button>
  </div>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button id="clear" class="btn">Borrar marcados</button>
    <label style="font-size:13px;color:#555;margin-left:6px">
      Guardado automático: <input type="checkbox" id="autosave" checked>
    </label>
  </div>
</div>

<div class="calendar" id="calendar"></div>
<div class="resumen" id="resumen"></div>

<div id="tablaMensual">
  <h2>Resumen días laborales por mes</h2>
  <table>
    <thead>
      <tr>
        <th>Mes</th>
        <th>Días laborales totales</th>
        <th>Festivos fijos</th>
        <th>Días marcados (puente/fiesta/cierre)</th>
        <th>Jornadas parciales</th>
        <th>Vacaciones seleccionadas</th>
        <th>Días libres seleccionados</th>
        <th>Días laborales restantes</th>
        <th>Horas estimadas restantes</th>
      </tr>
    </thead>
    <tbody id="tbodyTabla"></tbody>
  </table>
</div>

<script>
const YEAR = 2026;
const HORAS_OBJETIVO = 1750;
const HORAS_POR_DIA = 8;
const VACACIONES_DIAS = 15;
const LS_KEY = 'cal2026_final_v6';
const FESTIVOS_FIJOS = ['2026-01-01','2026-01-06','2026-04-03','2026-04-06','2026-05-01','2026-06-24','2026-08-15','2026-10-12','2026-11-01','2026-12-06','2026-12-08','2026-12-25','2026-09-11'];

function fechaStr(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function getDiaSemana(y,m,d){ return new Date(y,m,d).getDay(); }
function esFinSemana(y,m,d){ const dd=getDiaSemana(y,m,d); return dd===0||dd===6; }

let marcados = new Map();
let claseSeleccionada = 'puente';

const legendButtons = Array.from(document.querySelectorAll('#legend button'));
legendButtons.forEach(btn => {
  btn.addEventListener('click', ()=>{
    legendButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    claseSeleccionada = btn.dataset.class;
  });
});
legendButtons[0].classList.add('active');

const container = document.getElementById('calendar');

function cargar() {
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && obj.marcados){
      marcados = new Map(Object.entries(obj.marcados));
    }
  }catch(e){console.warn('No se pudo cargar',e);}
}

function guardar(){
  if(!document.getElementById('autosave').checked) return;
  const obj = {marcados:Object.fromEntries(marcados)};
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}

document.getElementById('clear').addEventListener('click', ()=>{
  if(!confirm('Borrar todas las marcas de usuario?')) return;
  marcados = new Map();
  localStorage.removeItem(LS_KEY);
  renderizarCalendario();
});

/* marcar 20 julio al inicio */
marcados.set('2026-07-20','fiesta-local');

function renderizarCalendario(){
  container.innerHTML = '';
  for(let mes=0; mes<12; mes++){
    const mesDiv = document.createElement('div'); mesDiv.className='month';
    const nombreMes = new Date(YEAR,mes).toLocaleString('es-ES',{month:'long'});
    mesDiv.innerHTML=`<h2>${nombreMes}</h2>`;
    const daysDiv = document.createElement('div'); daysDiv.className='days';
    ['L','M','X','J','V','S','D'].forEach(lbl=>{const h=document.createElement('div'); h.className='day header'; h.textContent=lbl; daysDiv.appendChild(h);});
    const primerDia = new Date(YEAR,mes,1).getDay();
    const offset = primerDia===0?6:primerDia-1;
    for(let i=0;i<offset;i++){ const e=document.createElement('div'); e.className='day vacio'; daysDiv.appendChild(e);}
    const diasEnMes = new Date(YEAR,mes+1,0).getDate();
    for(let d=1; d<=diasEnMes; d++){
      const fecha = fechaStr(YEAR,mes,d);
      const el = document.createElement('div'); el.className='day'; el.textContent=d;
      if(esFinSemana(YEAR,mes,d)){ el.classList.add('vacio'); daysDiv.appendChild(el); continue;}
      if(FESTIVOS_FIJOS.includes(fecha)){ el.classList.add('festivo'); daysDiv.appendChild(el); continue;}
      if(marcados.has(fecha)){
        const clase = marcados.get(fecha);
        if(clase.startsWith('jornada-parcial')) el.classList.add('jornada-parcial');
        else el.classList.add(clase);
      } else { el.classList.add('laboral'); }

      el.addEventListener('click', ()=>{
        if(FESTIVOS_FIJOS.includes(fecha)) return;
        if(marcados.has(fecha)){ marcados.delete(fecha); } 
        else { 
          if(claseSeleccionada==='jornada-parcial'){
            let h = prompt("Horas a trabajar este día (max 8h)", "6");
            h = parseFloat(h);
            if(isNaN(h) || h<0 || h>8) h=6;
            marcados.set(fecha, `jornada-parcial:${h}`);
          } else {
            marcados.set(fecha, claseSeleccionada);
          }
        }
        guardar();
        renderizarCalendario();
      });

      daysDiv.appendChild(el);
    }
    mesDiv.appendChild(daysDiv);
    container.appendChild(mesDiv);
  }
  calcularResumen();
  generarTablaMensual();
}

function calcularResumen(){
  let horasTrabajadas = 0;
  let diasVacacionesMarcados = 0;
  let diasLibresMarcados = 0;
  for(let mes=0; mes<12; mes++){
    const diasEnMes = new Date(YEAR,mes+1,0).getDate();
    for(let d=1; d<=diasEnMes; d++){
      const fecha = fechaStr(YEAR,mes,d);
      if(esFinSemana(YEAR,mes,d)) continue;
      if(FESTIVOS_FIJOS.includes(fecha)) continue;

      if(marcados.has(fecha)){
        const clase = marcados.get(fecha);
        if(clase.startsWith('jornada-parcial')){
          let h = parseFloat(clase.split(':')[1]);
          horasTrabajadas += h;
        } else if(clase==='vacaciones'){
          diasVacacionesMarcados++;
        } else if(clase==='dias-libres'){
          diasLibresMarcados++;
        } else {
          horasTrabajadas += 0;
        }
      } else {
        horasTrabajadas += HORAS_POR_DIA;
      }
    }
  }

  let excesoHoras = horasTrabajadas - HORAS_OBJETIVO;
  if(excesoHoras<0) excesoHoras=0;
  const diasVacacionesDisponibles = Math.max(0,VACACIONES_DIAS - diasVacacionesMarcados);
  const diasLibresDisponibles = Math.max(0, Math.floor(excesoHoras/HORAS_POR_DIA) - diasLibresMarcados);
  const horasRestantesLibres = Math.max(0, excesoHoras - ((Math.floor(excesoHoras/HORAS_POR_DIA))*HORAS_POR_DIA));

  document.getElementById('resumen').innerHTML=`
    <p><b>Horas objetivo:</b> ${HORAS_OBJETIVO} h</p>
    <p><b>Horas trabajadas estimadas:</b> ${horasTrabajadas} h</p>
    <p><b>Exceso de horas / tiempo libre:</b> ${excesoHoras} h</p>
    <hr/>
    <p><b>Vacaciones disponibles:</b> ${diasVacacionesDisponibles} días</p>
    <p><b>Días libres disponibles:</b> ${diasLibresDisponibles} días y ${horasRestantesLibres} h</p>
    <hr/>
    <p style="font-size:13px;color:#444">Festivos fijos en rojo. Puente/Fiesta/Cierre = 0h. Jornada parcial = h trabajadas. Vacaciones/Días libres = seleccionados.</p>
  `;
}

function generarTablaMensual(){
  const tbody = document.getElementById('tbodyTabla');
  tbody.innerHTML = '';
  const nombresMes = Array.from({length:12},(_,i)=>new Date(YEAR,i).toLocaleString('es-ES',{month:'long'}));

  for(let mes=0; mes<12; mes++){
    const diasEnMes = new Date(YEAR,mes+1,0).getDate();
    let diasLaborales=0, festivosFijos=0, marcadosUser=0, jornadasParciales=0, vacacionesSel=0, diasLibresSel=0, horasMes=0;

    for(let d=1; d<=diasEnMes; d++){
      const fecha = fechaStr(YEAR,mes,d);
      if(esFinSemana(YEAR,mes,d)) continue;

      if(FESTIVOS_FIJOS.includes(fecha)){
        festivosFijos++;
        horasMes += 0;
      } else if(marcados.has(fecha)){
        const clase = marcados.get(fecha);
        if(clase.startsWith('jornada-parcial')) {
          jornadasParciales++;
          let h = parseFloat(clase.split(':')[1]);
          horasMes += h;
        } else if(clase==='vacaciones'){
          vacacionesSel++;
          horasMes += 0;
        } else if(clase==='dias-libres'){
          diasLibresSel++;
          horasMes += 0;
        } else {
          marcadosUser++;
          horasMes += 0;
        }
      } else {
        diasLaborales++;
        horasMes += HORAS_POR_DIA;
      }
    }

    const diasRestantes = diasLaborales + jornadasParciales; 
    tbody.innerHTML += `<tr>
      <td>${nombresMes[mes]}</td>
      <td>${diasLaborales + jornadasParciales}</td>
      <td>${festivosFijos}</td>
      <td>${marcadosUser}</td>
      <td>${jornadasParciales}</td>
      <td>${vacacionesSel}</td>
      <td>${diasLibresSel}</td>
      <td>${diasRestantes}</td>
      <td>${horasMes} h</td>
    </tr>`;
  }
}

cargar();
renderizarCalendario();
</script>
</body>
</html>
